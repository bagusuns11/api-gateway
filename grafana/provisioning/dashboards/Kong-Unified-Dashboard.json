{
  "id": null,
  "title": "Kong API Gateway - Unified Monitoring",
  "tags": ["kong", "api-gateway", "monitoring", "logging"],
  "timezone": "browser",
  "schemaVersion": 36,
  "version": 3,
  "panels": [
    {
      "type": "timeseries",
      "title": "Request Rate per Service",
      "datasource": { "type": "prometheus", "uid": "prometheus_ds" },
      "targets": [
        {
          "expr": "sum by (service) (rate(kong_http_requests_total[1m]))",
          "legendFormat": "{{service}}",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Latency p95 per Service",
      "datasource": { "type": "prometheus", "uid": "prometheus_ds" },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(kong_kong_latency_ms_bucket[1m])) by (le, service))",
          "legendFormat": "{{service}}",
          "refId": "B"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "HTTP Status Codes",
      "datasource": { "type": "prometheus", "uid": "prometheus_ds" },
      "targets": [
        { "expr": "rate(kong_http_requests_total{code=~\"2..\"}[1m])", "legendFormat": "2xx" },
        { "expr": "rate(kong_http_requests_total{code=~\"4..\"}[1m])", "legendFormat": "4xx" },
        { "expr": "rate(kong_http_requests_total{code=~\"5..\"}[1m])", "legendFormat": "5xx" }
      ]
    },
    {
      "type": "logs",
      "title": "Kong Access Logs",
      "targets": [
        {
          "datasource": { "type": "loki", "uid": "loki_ds" },
          "expr": "{container=\"kong\"} |~ \"/(akademik|kepegawaian)/api/\"",
          "refId": "C"
        }
      ],
      "options": {
        "showLabels": true,
        "showTime": true,
        "wrapLogMessage": true
      }
    },
	    {
      "type": "logs",
      "title": "Nginx Access Logs",
      "targets": [
        {
          "datasource": { "type": "loki", "uid": "loki_ds" },
          "expr": "{job=\"nginx-proxy-logs\", container=\"nginx-proxy\", filename=\"/var/log/nginx/access.log\"}",
          "refId": "D"
        }
      ],
      "options": {
        "showLabels": true,
        "showTime": true,
        "wrapLogMessage": true
      }
    },
    {
      "type": "logs",
      "title": "Nginx Error Logs",
      "targets": [
        {
          "datasource": { "type": "loki", "uid": "loki_ds" },
          "expr": "{job=\"nginx-proxy-logs\", container=\"nginx-proxy\", filename=\"/var/log/nginx/error.log\"}",
          "refId": "E"
        }
      ],
      "options": {
        "showLabels": true,
        "showTime": true,
        "wrapLogMessage": true
      }
    },
{
  "type": "table",
  "title": "Top Client IPs",
  "targets": [
    {
      "datasource": { "type": "loki", "uid": "loki_ds" },
      "expr": "topk(10, sum by (client_ip) (count_over_time({container=\"nginx-proxy\"} | regexp `^(?P<client_ip>\\d+\\.\\d+\\.\\d+\\.\\d+)` [5m])))"
      "refId": "F"
    }
  ],
  "options": {
    "showHeader": true
  }
},
{
  "type": "table",
  "title": "Top API Paths",
  "targets": [
    {
      "datasource": { "type": "loki", "uid": "loki_ds" },
      "expr": "topk(10, sum by (path) (count_over_time({container=\"nginx-proxy\"} | regexp `^(?P<client_ip>\\d+\\.\\d+\\.\\d+\\.\\d+) - - \\[[^]]+\\] \\\"(?P<method>[A-Z]+) (?P<path>[^ ]+)` [5m])))"

      "refId": "G"
    }
  ],
  "options": {
    "showHeader": true
  }
}
  ]
}
